<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Ride - Drift</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://yourdomain.com/favicon.png">
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=geometry"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .header {
            background: #ffffff;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #2563eb;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
        }

        /* Map Container */
        #map {
            flex: 1;
            width: 100%;
            position: relative;
        }

        /* Info Panel */
        .info-panel {
            background: white;
            padding: 20px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            max-height: 40vh;
            overflow-y: auto;
        }

        .info-panel-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .vehicle-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }

        .vehicle-icon {
            width: 20px;
            height: 20px;
        }

        /* Trip Details */
        .trip-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .detail-card {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        /* Destination Info */
        .destination-info {
            display: flex;
            align-items: start;
            gap: 12px;
            padding: 16px;
            background: #eff6ff;
            border-radius: 12px;
            border-left: 4px solid #2563eb;
        }

        .destination-icon {
            width: 24px;
            height: 24px;
            color: #2563eb;
            margin-top: 2px;
        }

        .destination-text {
            flex: 1;
        }

        .destination-label {
            font-size: 12px;
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .destination-address {
            font-size: 14px;
            color: #1e3a8a;
            line-height: 1.4;
        }

        /* Loading State */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            color: #6b7280;
        }

        /* Error State */
        .error-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .error-icon {
            width: 80px;
            height: 80px;
            background: #fef2f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .error-message {
            font-size: 16px;
            color: #6b7280;
            max-width: 400px;
        }

        /* Completed State */
        .completed-banner {
            background: #10b981;
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .info-panel {
                max-height: 50vh;
            }

            .trip-details {
                grid-template-columns: 1fr;
            }

            .driver-info {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Hide elements initially */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loading" class="loading-container">
        <div class="spinner"></div>
        <div class="loading-text">Loading trip details...</div>
    </div>

    <!-- Error State -->
    <div id="error" class="error-container hidden">
        <div class="error-icon">
            <svg width="40" height="40" fill="none" stroke="#ef4444" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        </div>
        <div class="error-title">Trip Not Found</div>
        <div class="error-message">This tracking link is invalid or has expired. Please ask the rider to share a new link.</div>
    </div>

    <!-- Completed Banner -->
    <div id="completedBanner" class="completed-banner">
        ✓ Trip completed successfully
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <circle cx="16" cy="16" r="14" fill="#2563eb" opacity="0.1"/>
                        <path d="M16 8L20 12H12L16 8Z" fill="#2563eb"/>
                        <rect x="14" y="12" width="4" height="8" rx="1" fill="#2563eb"/>
                        <circle cx="16" cy="22" r="2" fill="#2563eb"/>
                    </svg>
                    <span class="logo-text">Drift</span>
                </div>
                <div id="statusBadge" class="status-badge">
                    <div class="status-dot"></div>
                    <span>Live Tracking</span>
                </div>
            </div>
        </header>

        <!-- Container -->
        <div class="container">
            <!-- Map -->
            <div id="map"></div>

            <!-- Info Panel -->
            <div class="info-panel">
                <div class="info-panel-content">
                    <!-- Driver Info -->
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">D</div>
                        <div class="driver-details">
                            <div class="driver-name" id="driverName">Loading...</div>
                            <div class="vehicle-info">
                                <svg class="vehicle-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                    <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0h2.1a2.5 2.5 0 014.9 0H17a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v3a1 1 0 001 1h2V7h-2z"/>
                                </svg>
                                <span id="vehicleInfo">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Trip Details -->
                    <div class="trip-details">
                        <div class="detail-card">
                            <div class="detail-label">Distance</div>
                            <div class="detail-value" id="distance">Calculating...</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">ETA</div>
                            <div class="detail-value" id="eta">Calculating...</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Last Updated</div>
                            <div class="detail-value" id="lastUpdated">Just now</div>
                        </div>
                    </div>

                    <!-- Destination -->
                    <div class="destination-info">
                        <svg class="destination-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <div class="destination-text">
                            <div class="destination-label">Destination</div>
                            <div class="destination-address" id="destination">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let map;
        let driverMarker;
        let destinationMarker;
        let routeLine;
        let sessionId;
        let unsubscribe;

        // Get session ID from URL
        function getSessionId() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1] || new URLSearchParams(window.location.search).get('id');
        }

        // Initialize map
        function initMap(lat = 19.2866, lng = -81.3744) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat, lng },
                zoom: 13,
                disableDefaultUI: false,
                zoomControl: true,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            // Create driver marker (car icon)
            driverMarker = new google.maps.Marker({
                map: map,
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 5,
                    fillColor: '#2563eb',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                },
                title: 'Driver Location'
            });

            // Create destination marker
            destinationMarker = new google.maps.Marker({
                map: map,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="32" height="40" viewBox="0 0 32 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 0C7.16344 0 0 7.16344 0 16C0 24.8366 16 40 16 40C16 40 32 24.8366 32 16C32 7.16344 24.8366 0 16 0Z" fill="#ef4444"/>
                            <circle cx="16" cy="16" r="6" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(32, 40),
                    anchor: new google.maps.Point(16, 40),
                },
                title: 'Destination'
            });

            // Create route line
            routeLine = new google.maps.Polyline({
                map: map,
                strokeColor: '#2563eb',
                strokeOpacity: 0.7,
                strokeWeight: 4,
            });
        }

        // Update map with new data
        function updateMap(data) {
            if (!data.currentLocation || !data.destination) return;

            const driverPos = {
                lat: data.currentLocation.latitude,
                lng: data.currentLocation.longitude
            };

            const destPos = {
                lat: data.destination.latitude,
                lng: data.destination.longitude
            };

            // Update driver marker
            driverMarker.setPosition(driverPos);
            if (data.currentLocation.heading) {
                driverMarker.setIcon({
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 5,
                    fillColor: '#2563eb',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    rotation: data.currentLocation.heading
                });
            }

            // Update destination marker
            destinationMarker.setPosition(destPos);

            // Update route line
            routeLine.setPath([driverPos, destPos]);

            // Fit bounds to show both markers
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(driverPos);
            bounds.extend(destPos);
            map.fitBounds(bounds);

            // Calculate distance and ETA
            updateTripMetrics(driverPos, destPos);
        }

        // Update trip metrics
        function updateTripMetrics(driverPos, destPos) {
            // Calculate distance
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(driverPos.lat, driverPos.lng),
                new google.maps.LatLng(destPos.lat, destPos.lng)
            );

            const distanceKm = (distance / 1000).toFixed(1);
            const distanceMiles = (distance / 1609.34).toFixed(1);
            document.getElementById('distance').textContent = `${distanceKm} km (${distanceMiles} mi)`;

            // Estimate ETA (assuming average speed of 40 km/h in Cayman traffic)
            const averageSpeedKmh = 40;
            const etaMinutes = Math.round((distance / 1000) / averageSpeedKmh * 60);
            
            if (etaMinutes < 1) {
                document.getElementById('eta').textContent = 'Arriving now';
            } else if (etaMinutes < 60) {
                document.getElementById('eta').textContent = `${etaMinutes} min`;
            } else {
                const hours = Math.floor(etaMinutes / 60);
                const mins = etaMinutes % 60;
                document.getElementById('eta').textContent = `${hours}h ${mins}m`;
            }
        }

        // Update UI with session data
        function updateUI(data) {
            // Driver name
            const firstName = data.driverName;
            document.getElementById('driverName').textContent = firstName;
            document.getElementById('driverAvatar').textContent = firstName.charAt(0).toUpperCase();

            // Vehicle info
            const vehicle = data.vehicleInfo;
            document.getElementById('vehicleInfo').textContent = 
                `${vehicle.color} ${vehicle.make} ${vehicle.model} • •${vehicle.licensePlate}`;

            // Destination
            document.getElementById('destination').textContent = data.destination.address;

            // Last updated
            updateLastUpdated(data.currentLocation.timestamp);
        }

        // Update last updated timestamp
        function updateLastUpdated(timestamp) {
            if (!timestamp) return;

            const now = Date.now();
            const then = timestamp.toMillis ? timestamp.toMillis() : timestamp;
            const diff = Math.floor((now - then) / 1000);

            let text;
            if (diff < 10) {
                text = 'Just now';
            } else if (diff < 60) {
                text = `${diff}s ago`;
            } else if (diff < 3600) {
                text = `${Math.floor(diff / 60)}m ago`;
            } else {
                text = `${Math.floor(diff / 3600)}h ago`;
            }

            document.getElementById('lastUpdated').textContent = text;
        }

        // Show error
        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        // Show completed state
        function showCompleted() {
            document.getElementById('completedBanner').style.display = 'block';
            document.getElementById('statusBadge').innerHTML = '<span>✓ Completed</span>';
            document.getElementById('statusBadge').style.background = '#6b7280';
        }

        // Initialize tracking
        async function initTracking() {
            sessionId = getSessionId();

            if (!sessionId) {
                showError();
                return;
            }

            try {
                // Subscribe to real-time updates
                unsubscribe = db.collection('trackingSessions')
                    .doc(sessionId)
                    .onSnapshot((doc) => {
                        if (!doc.exists) {
                            showError();
                            return;
                        }

                        const data = doc.data();

                        // Check if expired or not active
                        if (data.status === 'expired' || 
                            (data.expiresAt && data.expiresAt.toMillis() < Date.now())) {
                            showError();
                            return;
                        }

                        // Check if completed
                        if (data.status === 'completed') {
                            showCompleted();
                        }

                        // Hide loading, show main content
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('mainContent').classList.remove('hidden');

                        // Initialize map if needed
                        if (!map) {
                            initMap(
                                data.currentLocation.latitude,
                                data.currentLocation.longitude
                            );
                        }

                        // Update UI and map
                        updateUI(data);
                        updateMap(data);
                    }, (error) => {
                        console.error('Error fetching tracking session:', error);
                        showError();
                    });

                // Update "last updated" every 10 seconds
                setInterval(() => {
                    const lastUpdatedEl = document.getElementById('lastUpdated');
                    if (lastUpdatedEl && !lastUpdatedEl.textContent.includes('Just now')) {
                        // Trigger re-render (will be updated on next snapshot)
                    }
                }, 10000);

            } catch (error) {
                console.error('Error initializing tracking:', error);
                showError();
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        // Start tracking when page loads
        window.addEventListener('load', initTracking);
    </script>
</body>
</html>